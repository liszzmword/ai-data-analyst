# 📊 데이터 기반 RAG 챗봇

거래처, 매출, 영업일지 데이터를 자연어로 질문할 수 있는 RAG(Retrieval-Augmented Generation) 챗봇입니다.

## ✨ 주요 기능

- 📁 **다중 데이터 소스 통합**: 거래처 데이터, 매출 데이터, 영업일지 통합 검색
- 🔍 **의미 기반 검색**: Sentence Transformers를 활용한 임베딩 기반 검색
- 🤖 **AI 답변 생성**: Google Gemini API를 활용한 자연어 답변
- 📊 **통계 분석**: 집계/통계 질의 자동 감지 및 계산
- 🎯 **근거 제시**: 답변의 출처(행 단위)를 명확히 표시
- 🔒 **개인정보 보호**: 사업자등록번호 등 민감정보 자동 마스킹
- 💾 **벡터 인덱스 캐싱**: 최초 1회 인덱싱 후 빠른 로딩

## 🏗️ 프로젝트 구조

```
rag_Test/
├── README.md                   # 프로젝트 문서
├── requirements.txt            # Python 의존성
├── config.py                   # 설정 파일
├── utils.py                    # 유틸리티 함수
├── codebook_loader.py          # 코드북 로더
├── data_loader.py              # 데이터 로더 및 문서 변환
├── vector_store.py             # 벡터 스토어 (FAISS)
├── query_processor.py          # 질의 처리 및 답변 생성
├── app.py                      # Streamlit UI
├── .cache/                     # 모델 캐시
├── vector_store/               # 벡터 인덱스 캐시
├── sales data.csv              # 매출 데이터
├── 거래처 데이터.csv            # 거래처 데이터
├── 영업일지2.csv                # 영업일지
└── 데이터 db.csv                # 코드북 (데이터 정의)
```

## 🚀 설치 및 실행

### 1. 필수 요구사항

- Python 3.8 이상
- pip

### 2. 의존성 설치

```bash
pip install -r requirements.txt
```

### 3. 데이터 파일 준비

다음 CSV 파일들이 프로젝트 루트 디렉토리에 있는지 확인하세요:

- `데이터 db.csv` - 코드북 (컬럼 정의)
- `거래처 데이터.csv` - 거래처 정보
- `sales data.csv` - 매출 데이터
- `영업일지2.csv` - 영업일지

### 4. 애플리케이션 실행

```bash
streamlit run app.py
```

브라우저에서 자동으로 `http://localhost:8501` 이 열립니다.

## 📖 사용 방법

### 기본 사용법

1. 좌측 사이드바에서 검색할 데이터셋을 선택합니다 (전체/거래처/매출/영업일지)
2. Top-K 값을 조정하여 검색할 문서 수를 설정합니다 (기본값: 5)
3. 질문 입력창에 자연어 질문을 입력합니다
4. '🔍 검색' 버튼을 클릭하거나 Enter를 누릅니다
5. 답변과 근거 문서를 확인합니다

### 예시 질문 10개

#### 1. 거래처 정보 조회
```
한국케미칼상사에 대해 알려주세요
```
**예상 동작**: 한국케미칼상사의 거래처 정보를 검색하고, 거래처코드, 담당자, 거래 유형 등의 정보를 제공합니다.

#### 2. 특정 거래처 검색
```
이놀의 거래처 정보를 알려주세요
```
**예상 동작**: 주식회사 이놀의 상세 정보와 관련 매출/영업일지 데이터를 함께 제공합니다.

#### 3. 최근 활동 조회
```
최근 영업일지를 보여주세요
```
**예상 동작**: 날짜 컬럼을 기준으로 최근 영업 활동 내역을 검색하여 제시합니다.

#### 4. 매출 통계 (집계)
```
매출 상위 거래처는?
```
**예상 동작**: 통계성 질의로 인식하여 거래처별 매출을 집계하고 Top N을 표 형태로 제공합니다.

#### 5. 합계 계산
```
거래처별 매출 합계를 알려주세요
```
**예상 동작**: pandas를 사용하여 거래처별로 매출을 그룹화하고 합계를 계산하여 제시합니다.

#### 6. 제품 기반 검색
```
PS양면 제품을 구매한 거래처는?
```
**예상 동작**: 제품명으로 검색하여 해당 제품을 구매한 거래처 목록과 매출 정보를 제공합니다.

#### 7. 카테고리 기반 검색
```
거래처 중 냉장고 관련 거래처는?
```
**예상 동작**: 제품 카테고리나 관련 키워드로 거래처를 필터링하여 제공합니다.

#### 8. 영업 활동 조회
```
최근 방문한 거래처는?
```
**예상 동작**: 영업일지에서 최근 방문 기록을 검색하여 날짜와 함께 제공합니다.

#### 9. 리스트 조회
```
주요 거래처 목록을 보여주세요
```
**예상 동작**: 거래처 데이터에서 주요 거래처들을 추출하여 리스트 형태로 제공합니다.

#### 10. 제품 매출 분석
```
매출액이 높은 제품은?
```
**예상 동작**: 매출 데이터에서 제품별 매출액을 집계하여 상위 제품을 표로 제시합니다.

## 🔧 주요 기술 스택

- **프레임워크**: Streamlit (웹 UI)
- **임베딩 모델**: Sentence Transformers (`paraphrase-multilingual-MiniLM-L12-v2`)
- **벡터 DB**: FAISS (Facebook AI Similarity Search)
- **LLM**: Google Gemini Pro (답변 생성)
- **데이터 처리**: pandas, numpy

## 📝 시스템 동작 원리

### 1. 데이터 로딩 및 변환
- CSV 파일을 여러 인코딩(utf-8-sig, cp949 등)으로 자동 fallback 시도
- 코드북(`데이터 db.csv`)을 읽어 컬럼 코드(A-1, B-2 등) → 한글 항목명 매핑 생성
- 각 행(row)을 하나의 Document로 변환
- 민감정보(사업자등록번호 등) 자동 마스킹

### 2. 벡터 인덱싱
- Sentence Transformers로 각 문서의 임베딩 벡터 생성
- FAISS 인덱스에 저장하여 빠른 유사도 검색 가능
- 디스크에 캐싱하여 재실행 시 빠른 로딩

### 3. 질의 처리
- 사용자 질의가 통계성 질의인지 자동 감지 (키워드: 합계, Top, 평균 등)
- 벡터 검색으로 관련 문서 Top-K 개 추출
- 통계성 질의인 경우 pandas로 집계 수행

### 4. 답변 생성
- 검색된 문서와 통계 결과를 컨텍스트로 구성
- Google Gemini API에 프롬프트 전송
- 한국어로 자연스러운 답변 생성
- 근거(출처) 정보와 함께 제시

## 🔐 개인정보 보호

다음 패턴에 대해 자동 마스킹 처리됩니다:

- **사업자등록번호**: `214-86-59900` → `214-**-***00`
- **주민등록번호**: `123456-1234567` → `123456-*******`
- **전화번호**: `010-1234-5678` → `010-****-5678`

## 🎯 코드북 활용

`데이터 db.csv` 파일의 구조:

| 파일 구분 | 섹션 | 번호 | 항목 | 항목설명 | 예시 및 선택지 |
|----------|------|------|------|----------|---------------|
| 거래처 데이터 | A. 식별 | A-1 | 번호 | 거래처코드 고유번호 | 1\|2\|3 |
| 거래처 데이터 | B. 거래처 정보 | B-1 | 거래처 | 거래처명(상호) | (주)한국케미칼상사 |

- **파일 구분**: 어느 CSV 파일의 정의인지 (거래처 데이터/매출 데이터/영업일지)
- **번호**: 컬럼 코드 (A-1, B-2 등)
- **항목**: 한글 항목명
- **항목설명**: 상세 설명

시스템은 이 코드북을 기반으로 코드를 자동으로 한글로 변환합니다.

## 🔄 캐시 관리

### 벡터 인덱스 재생성

데이터가 변경되었거나 인덱스를 다시 생성하려면:

1. UI 좌측 사이드바에서 "🔄 벡터 인덱스 재생성" 버튼 클릭
2. 또는 `vector_store/` 폴더 삭제 후 재실행

### 수동 캐시 삭제

```bash
rm -rf vector_store/
rm -rf .cache/
```

## 🐛 문제 해결

### 인코딩 오류
- CSV 파일의 인코딩이 자동으로 감지되지 않는 경우, `config.py`의 `ENCODINGS` 리스트에 인코딩을 추가하세요.

### API 키 오류
- Google Gemini API 키가 유효한지 확인하세요.
- `config.py`의 `GOOGLE_API_KEY`를 확인하세요.

### 메모리 부족
- `config.py`의 `DEFAULT_TOP_K` 값을 줄이세요.
- 더 작은 임베딩 모델을 사용하세요.

### 검색 결과가 부정확
- `top_k` 값을 늘려보세요 (5 → 10)
- 질문을 더 구체적으로 작성하세요.

## 📊 성능 최적화

- 벡터 인덱스는 최초 1회만 생성되고 캐싱됩니다.
- Streamlit의 `@st.cache_resource`로 모델과 데이터를 캐싱합니다.
- FAISS의 Inner Product 검색으로 빠른 유사도 계산이 가능합니다.

## 🤝 기여

이슈나 개선 사항이 있다면 자유롭게 제안해주세요!

## 📄 라이선스

MIT License

---

**Powered by Sentence Transformers + FAISS + Google Gemini**
